<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Календарь для Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Общие стили */
        :root {
            --bg-main: #1a1a2e;
            --bg-container: #0f3460;
            --bg-element: #2d3748;
            --bg-element-hover: #4a5568;
            --bg-accent: #533483;
            --bg-weekend: #3d2a45;
            --text-main: #e0e6ed;
            --text-light: #ffffff;
            --border-main: #4a5568;
            --border-accent: #00bfff;
            --btn-green: #059669;
            --btn-green-hover: #047857;
            --btn-red: #dc2626;
            --btn-red-hover: #b91c1c;
            --btn-blue: #2563eb;
            --btn-blue-hover: #1d4ed8;
            --shadow-main: rgba(0,0,0,0.3);
            --shadow-accent: rgba(0, 191, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow-main);
            overflow: hidden;
        }
        .unauthorized {
            text-align: center;
            padding: 50px;
        }

        /* Заголовок */
        .header {
            background: linear-gradient(135deg, var(--bg-accent) 0%, var(--bg-container) 100%);
            color: var(--text-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            text-align: center;
        }
        .user-info {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .user-info span {
            font-weight: bold;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 300;
        }

        .month-selector {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px 15px;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
        }

        .month-selector option {
            background: var(--bg-container);
            color: var(--text-light);
        }

        /* Кнопки */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-height: 44px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: var(--text-light);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn--save { background: var(--btn-green); }
        .btn--save:hover:not(:disabled) { background: var(--btn-green-hover); }
        .btn--clear { background: var(--btn-red); }
        .btn--clear:hover:not(:disabled) { background: var(--btn-red-hover); }
        .btn--cancel { background: var(--bg-element-hover); }
        .btn--cancel:hover:not(:disabled) { background: var(--bg-element); }
        .btn--edit-mode { background: var(--btn-blue); }
        .btn--edit-mode:hover:not(:disabled) { background: var(--btn-blue-hover); }
        .btn--toggle {
            background: var(--bg-element);
            border: 1px solid var(--border-main);
            box-shadow: none;
            padding: 8px 15px;
        }
        .btn--toggle:hover:not(:disabled) {
            background: var(--bg-element-hover);
            transform: none;
        }

        /* Основное содержимое */
        .main-content {
            padding: 20px;
        }

        .section-container {
            background: var(--bg-main);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--bg-element);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-container h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        /* Навигация */
        .tab-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .tab-button {
            background: var(--bg-element-hover);
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 150px;
            text-align: center;
        }
        .tab-button.active {
            background: linear-gradient(135deg, var(--bg-accent) 0%, var(--bg-container) 100%);
            border: 2px solid var(--border-accent);
            box-shadow: 0 0 15px var(--shadow-accent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Сетка календаря */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--bg-element);
            border-radius: 10px;
            overflow: hidden;
        }
        .day-header {
            background: var(--bg-element-hover);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        .day-cell {
            background: var(--bg-element);
            min-height: 100px;
            padding: 8px 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 4px;
            border: 1px solid var(--border-main);
            border-radius: 8px;
        }
        .day-cell:hover:not(.empty) {
            background: var(--bg-element-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-main);
        }
        .day-cell.weekend { background: var(--bg-weekend); }
        .day-cell.weekend:hover:not(.empty) { background: #553c5d; }
        .day-cell.empty {
            background: var(--bg-main);
            cursor: default;
            box-shadow: none;
            transform: none;
        }
        .day-cell.current-day {
            border: 2px solid var(--border-accent);
            box-shadow: 0 0 15px var(--shadow-accent);
        }
        .day-cell.selected-for-modal {
            border: 3px solid var(--border-accent);
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.9);
            transform: scale(1.03);
        }
        .day-number {
            font-weight: 600;
            font-size: 15px;
        }
        .day-entries-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex-grow: 1;
            overflow: hidden;
        }
        .day-entry {
            font-size: 10px;
            padding: 3px 4px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
        }
        .day-entry .shift-type {
            font-size: 8px;
            margin-left: 4px;
            opacity: 0.8;
        }

        /* Кнопки действий */
        .action-buttons-wrapper {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .action-buttons-wrapper.hidden {
            display: none;
        }

        /* Секции статистики и управления */
        .hidden-section { display: none; }
        .stats-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .stats-item {
            background: var(--bg-element);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-name {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .stats-count {
            font-size: 16px;
            font-weight: 600;
            background: var(--bg-element-hover);
            padding: 4px 10px;
            border-radius: 15px;
        }
        .officer-management-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .officer-management-controls input[type="text"] {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-main);
            background: var(--bg-element);
            color: var(--text-main);
            min-width: 150px;
        }
        .current-officers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        .current-officer-item {
            background: var(--bg-element);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-officer-item .delete-officer-btn {
            background: none;
            border: none;
            color: var(--btn-red);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 5px;
            border-radius: 50%;
        }
        .current-officer-item .delete-officer-btn:hover {
            color: var(--btn-red-hover);
            background: rgba(220, 38, 38, 0.2);
        }

        /* Модальные окна */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--bg-container);
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            border: 1px solid var(--bg-element);
            box-shadow: 0 10px 20px var(--shadow-main);
            transform: translateY(-50px);
            transition: all 0.3s ease;
        }
        .modal-overlay.show .modal {
            transform: translateY(0);
        }
        .modal-header {
            background: linear-gradient(135deg, var(--bg-accent) 0%, var(--bg-container) 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h4 { font-size: 1.2em; font-weight: 500; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { background: rgba(255,255,255,0.2); }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        
        /* Содержимое модальных окон */
        .officer-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .officer-option {
            padding: 15px;
            border: 2px solid var(--border-main);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-element);
            text-align: center;
        }
        .officer-option:hover {
            border-color: var(--bg-accent);
            background: var(--bg-element-hover);
        }
        .officer-option.selected {
            border-color: var(--bg-accent);
            background: var(--bg-accent);
            color: var(--text-light);
        }
        .assignment-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid var(--border-main);
            border-radius: 8px;
            padding: 10px;
            background: var(--bg-element);
            margin-bottom: 15px;
        }
        .assignment-controls select, .assignment-controls input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--bg-accent);
            background: var(--bg-main);
            color: var(--text-main);
        }
        .assignments-list-container h5 { margin-bottom: 10px; }
        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 5px;
        }
        .assignment-item .delete-assignment-btn {
            background: none; border: none; color: var(--btn-red); font-size: 18px; cursor: pointer;
        }
        .confirm-modal .modal-body { text-align: center; font-size: 1.1em; }
        .confirm-modal .modal-footer { display: flex; justify-content: center; gap: 15px; padding: 20px; }

        /* Уведомления */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            padding: 15px 25px;
            border-radius: 8px;
            color: var(--text-light);
            font-weight: 500;
            z-index: 2000;
            transition: transform 0.4s ease-in-out;
            box-shadow: 0 5px 15px var(--shadow-main);
        }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification.success { background: var(--btn-green); }
        .notification.error { background: var(--btn-red); }
        .notification.info { background: var(--btn-blue); }
        
        /* Увеличенный просмотр дня */
        .enlarged-day-content {
            padding: 30px;
            text-align: center;
        }
        .enlarged-day-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: var(--border-accent);
        }
        .enlarged-day-content p {
            font-size: 1.2em;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header h1 { font-size: 1.5em; }
            .main-content, .section-container { padding: 15px; }
            .day-cell { min-height: 80px; padding: 6px 4px; }
            .day-number { font-size: 14px; }
            .day-entry { font-size: 9px; }
            .stats-list, .current-officers-list { grid-template-columns: 1fr; }
            .officer-list { grid-template-columns: 1fr; }
            .tab-button { flex-grow: 1; }
        }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <!-- MODALS (kept outside the main container for positioning) -->
    <!-- Universal Modal for Editing -->
    <div class="modal-overlay" id="editModalOverlay">
        <div class="modal" id="editModal">
            <div class="modal-header">
                <h4 id="editModalTitle"></h4>
                <button class="modal-close" data-action="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="editModalBody"></div>
        </div>
    </div>
    
    <!-- Enlarged Day View Modal -->
    <div class="modal-overlay" id="viewModalOverlay" data-action="closeModal">
        <div class="modal">
            <div class="modal-header">
                <h4 id="viewModalTitle">Просмотр дня</h4>
                <button class="modal-close" data-action="closeModal">&times;</button>
            </div>
            <div class="modal-body enlarged-day-content" id="viewModalBody"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay confirm-modal" id="confirmModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h4>Подтверждение</h4>
                <button class="modal-close" data-action="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body" id="confirmModalMessage"></div>
            <div class="modal-footer">
                <button class="btn btn--save" id="confirmModalConfirmBtn">Да</button>
                <button class="btn btn--cancel" id="confirmModalCancelBtn">Отмена</button>
            </div>
        </div>
    </div>

    <script>
    // Оборачиваем весь код в IIFE для создания замкнутой области видимости
    (function() {
        'use strict';

        /**
         * CONFIG: Константы и конфигурация приложения
         */
        const CONFIG = {
            ROLES: {
                // !!! ЗАМЕНИТЕ ЭТИ ID НА РЕАЛЬНЫЕ TELEGRAM ID !!!
                670669284: 'admin',   // Пример ID администратора
                987654321: 'user',    // Пример ID пользователя
            },
            DOM_SELECTORS: {
                container: '#appContainer',
                monthSelector: '#monthSelector',
                newOfficerName: '#newOfficerName',
                dutyCalendarGrid: '#dutyCalendarGrid',
                technicianCalendarGrid: '#technicianCalendarGrid',
                generalCalendarGrid: '#generalCalendarGrid',
                statsList: '#statsList',
                currentOfficersList: '#currentOfficersList',
                actionButtons: '#actionButtons',
                tabNavigation: '#tabNavigation',
                editModal: {
                    overlay: '#editModalOverlay',
                    title: '#editModalTitle',
                    body: '#editModalBody',
                },
                viewModal: {
                    overlay: '#viewModalOverlay',
                    title: '#viewModalTitle',
                    body: '#viewModalBody',
                },
                confirmModal: {
                    overlay: '#confirmModalOverlay',
                    message: '#confirmModalMessage',
                    confirmBtn: '#confirmModalConfirmBtn',
                    cancelBtn: '#confirmModalCancelBtn',
                },
            },
            STORAGE_KEYS: {
                DUTIES: 'calendar_duties_v2.5',
                TECH_DUTIES: 'calendar_tech_duties_v2.5',
                GENERAL_SCHEDULE: 'calendar_general_schedule_v2.5',
                OFFICERS: 'calendar_officers_v2.5',
                TECHNICIANS: 'calendar_technicians_v2.5',
                COLORS: 'calendar_colors_v2.5',
            },
            SHIFT_TYPES: ["8", "ДС", "День караул", "Ночь караул", "Отсыпной", "Выходной", "Отпуск", "Больничный", "8pc"],
            NO_DUTY_LABEL: "Нет дежурства",
            NAME_REGEX: /^[А-ЯЁ][а-яё]+\s[А-ЯЁ]\.[А-ЯЁ]\.$/,
            INITIAL_DATA: {
                officers: ["Морозов В.А.", "Ребраков Т.В.", "Костырин С.С.", "Бонадыков В.В.", "Бурлаков М.Ю.", "Артемьев А.М.", "Мефед И.С."],
                technicians: ["Ребраков Т.В.", "Морозов В.А.", "Кузавлев П.С.", "Лебедев А.В.", "Денщиков А.А."],
                julyDuties: { "1": "Ребраков Т.В.", "2": "Костырин С.С.", "3": "Морозов В.А.", "4": "Ребраков Т.В.", "6": "Костырин С.С.", "7": "Костырин С.С.", "8": "Ребраков Т.В.", "9": "Морозов В.А.", "10": "Морозов В.А.", "11": "Костырин С.С.", "12": "Ребраков Т.В.", "13": "Морозов В.А.", "14": "Костырин С.С.", "15": "Ребраков Т.В.", "16": "Морозов В.А.", "17": "Ребраков Т.В.", "18": "Ребраков Т.В.", "19": "Костырин С.С.", "20": "Морозов В.А.", "21": "Костырин С.С.", "22": "Ребраков Т.В.", "23": "Морозов В.А.", "24": "Костырин С.С.", "25": "Ребраков Т.В.", "26": "Морозов В.А.", "27": "Костырин С.С.", "28": "Костырин С.С.", "29": "Морозов В.А.", "30": "Костырин С.С.", "31": "Ребраков Т.В." },
            }
        };

        /**
         * STATE: Единственный источник правды для состояния приложения.
         */
        const STATE = {
            telegramUser: null,
            userRole: 'guest',
            year: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            activeTab: 'duty',
            isEditMode: false,
            hasUnsavedChanges: false,
            duties: {},
            techDuties: {},
            generalSchedule: {},
            officers: [],
            technicians: [],
            colors: {},
            confirmModalResolve: null,
            currentSelectedDay: null,
        };

        /**
         * SERVICE: "Мозг" приложения. Управляет состоянием и бизнес-логикой.
         */
        const SERVICE = {
            init() {
                this.initTelegram();
                if (STATE.userRole === 'guest') {
                    VIEW.renderUnauthorized();
                    return;
                }
                this.loadData();
                VIEW.init();
                CONTROLLER.init();
                console.log("Application Initialized for user:", STATE.telegramUser, "with role:", STATE.userRole);
            },

            initTelegram() {
                const tg = window.Telegram.WebApp;
                tg.ready();
                STATE.telegramUser = tg.initDataUnsafe.user;
                // Для тестирования в браузере
                if (!STATE.telegramUser) {
                    STATE.telegramUser = { id: 123456789, first_name: 'Admin', username: 'test_admin' };
                }
                STATE.userRole = CONFIG.ROLES[STATE.telegramUser.id] || 'guest';
                tg.expand();
            },

            // --- Управление данными ---
            loadData() {
                const userId = STATE.telegramUser.id;
                const loadItem = (key, defaultValue = {}) => {
                    try {
                        const item = localStorage.getItem(`${key}_${userId}`);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (e) {
                        console.error(`Error parsing ${key} from localStorage`, e);
                        return defaultValue;
                    }
                };

                STATE.duties = loadItem(CONFIG.STORAGE_KEYS.DUTIES, {});
                STATE.techDuties = loadItem(CONFIG.STORAGE_KEYS.TECH_DUTIES, {});
                STATE.generalSchedule = loadItem(CONFIG.STORAGE_KEYS.GENERAL_SCHEDULE, {});
                STATE.officers = loadItem(CONFIG.STORAGE_KEYS.OFFICERS, [...CONFIG.INITIAL_DATA.officers]);
                STATE.technicians = loadItem(CONFIG.STORAGE_KEYS.TECHNICIANS, [...CONFIG.INITIAL_DATA.technicians]);
                STATE.colors = loadItem(CONFIG.STORAGE_KEYS.COLORS, {});

                if (STATE.currentMonth === 6 && !Object.keys(STATE.duties[6] || {}).length) {
                    STATE.duties[6] = { ...CONFIG.INITIAL_DATA.julyDuties };
                }

                for (let i = 0; i < 12; i++) {
                    if (!STATE.duties[i]) STATE.duties[i] = {};
                    if (!STATE.techDuties[i]) STATE.techDuties[i] = {};
                    if (!STATE.generalSchedule[i]) STATE.generalSchedule[i] = {};
                }
                
                STATE.hasUnsavedChanges = false;
            },

            saveData() {
                const userId = STATE.telegramUser.id;
                try {
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.DUTIES}_${userId}`, JSON.stringify(STATE.duties));
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.TECH_DUTIES}_${userId}`, JSON.stringify(STATE.techDuties));
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.GENERAL_SCHEDULE}_${userId}`, JSON.stringify(STATE.generalSchedule));
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.OFFICERS}_${userId}`, JSON.stringify(STATE.officers));
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.TECHNICIANS}_${userId}`, JSON.stringify(STATE.technicians));
                    localStorage.setItem(`${CONFIG.STORAGE_KEYS.COLORS}_${userId}`, JSON.stringify(STATE.colors));
                    
                    STATE.hasUnsavedChanges = false;
                    VIEW.showNotification('Изменения успешно сохранены!', 'success');
                    VIEW.renderAll();
                } catch (e) {
                    console.error("Error saving data to localStorage", e);
                    VIEW.showNotification('Ошибка сохранения данных', 'error');
                }
            },

            // --- Управление UI ---
            async changeMonth(newMonth) {
                if (STATE.hasUnsavedChanges) {
                    const confirmed = await VIEW.showConfirmModal('У вас есть несохраненные изменения. Вы уверены, что хотите продолжить без сохранения?');
                    if (!confirmed) {
                        document.querySelector(CONFIG.DOM_SELECTORS.monthSelector).value = STATE.currentMonth;
                        return;
                    }
                }
                STATE.currentMonth = parseInt(newMonth, 10);
                this.loadData();
                VIEW.renderAll();
            },

            async toggleEditMode() {
                if (STATE.userRole === 'guest') {
                    VIEW.showNotification('У вас нет прав для редактирования.', 'error');
                    return;
                }
                if (STATE.isEditMode && STATE.hasUnsavedChanges) {
                    const confirmed = await VIEW.showConfirmModal('У вас есть несохраненные изменения. Сохранить их перед выходом?');
                    if (confirmed) this.saveData();
                    else this.loadData();
                }
                STATE.isEditMode = !STATE.isEditMode;
                VIEW.showNotification(STATE.isEditMode ? 'Режим редактирования включен' : 'Режим просмотра', 'info');
                VIEW.renderAll();
            },

            switchTab(tabName) {
                STATE.activeTab = tabName;
                VIEW.renderAll();
            },
            
            // --- Логика календаря ---
            handleDayClick(day, calendarType) {
                STATE.currentSelectedDay = day;
                if (STATE.isEditMode) {
                    if (calendarType === 'duty') VIEW.showDutyModal();
                    else VIEW.showAssignmentModal(calendarType);
                } else {
                    VIEW.showEnlargedDayView(day);
                }
            },

            assignDuty(person) {
                const { currentMonth, currentSelectedDay: day } = STATE;
                const dayKey = day.toString();
                const assignment = { person, shift: 'ДС' };
                const isPersonTechnician = STATE.technicians.includes(person);
                const actionType = person === CONFIG.NO_DUTY_LABEL ? 'delete' : 'add';

                if (actionType === 'delete') delete STATE.duties[currentMonth][dayKey];
                else STATE.duties[currentMonth][dayKey] = person;

                const update = (schedule, key, assign, add) => {
                    const current = schedule[currentMonth][key] || [];
                    let filtered = current.filter(a => a.shift !== 'ДС');
                    if (add) {
                        filtered.push(assign);
                        filtered.sort((a,b) => a.person.localeCompare(b.person));
                    }
                    if (filtered.length > 0) schedule[currentMonth][key] = filtered;
                    else delete schedule[currentMonth][key];
                };
                
                update(STATE.generalSchedule, dayKey, assignment, actionType === 'add');
                if (isPersonTechnician) update(STATE.techDuties, dayKey, assignment, actionType === 'add');

                STATE.hasUnsavedChanges = true;
                VIEW.closeModal();
                VIEW.renderAll();
            },

            addAssignment(person, shift, calendarType) {
                const { currentMonth, currentSelectedDay: day } = STATE;
                const dayKey = day.toString();
                const scheduleKey = calendarType === 'technician' ? 'techDuties' : 'generalSchedule';
                
                const assignments = STATE[scheduleKey][currentMonth][dayKey] || [];
                const newAssignment = { person, shift };

                if (assignments.some(a => a.person === person && a.shift === shift)) {
                    VIEW.showNotification('Такое назначение уже существует.', 'info');
                    return;
                }
                assignments.push(newAssignment);
                assignments.sort((a, b) => a.person.localeCompare(b.person));
                STATE[scheduleKey][currentMonth][dayKey] = assignments;

                this.syncSchedules('add', newAssignment, calendarType);

                STATE.hasUnsavedChanges = true;
                VIEW.renderAssignmentModalList(calendarType);
                VIEW.renderAll(); 
            },

            deleteAssignment(index, calendarType) {
                const { currentMonth, currentSelectedDay: day } = STATE;
                const scheduleKey = calendarType === 'technician' ? 'techDuties' : 'generalSchedule';
                const assignments = STATE[scheduleKey][currentMonth][day];
                const deletedAssignment = assignments.splice(index, 1)[0];
                if (assignments.length === 0) delete STATE[scheduleKey][currentMonth][day];

                this.syncSchedules('delete', deletedAssignment, calendarType);

                STATE.hasUnsavedChanges = true;
                VIEW.renderAssignmentModalList(calendarType);
                VIEW.renderAll();
            },
            
            syncSchedules(actionType, assignment, sourceCalendar) {
                const { person, shift } = assignment;
                const { currentMonth, currentSelectedDay: day } = STATE;
                const dayKey = day.toString();
                
                const isPersonOfficer = STATE.officers.includes(person);
                const isPersonTechnician = STATE.technicians.includes(person);

                const update = (schedule, key, assign, add) => {
                    const current = schedule[currentMonth][key] || [];
                    let filtered = current.filter(a => !(a.person === assign.person && a.shift === assign.shift));
                    if (add) {
                        filtered.push(assign);
                        filtered.sort((a,b) => a.person.localeCompare(b.person));
                    }
                    if (filtered.length > 0) schedule[currentMonth][key] = filtered;
                    else delete schedule[currentMonth][key];
                };

                if (sourceCalendar === 'technician') {
                    update(STATE.generalSchedule, dayKey, assignment, actionType === 'add');
                } else if (sourceCalendar === 'general') {
                    if (shift === 'ДС' && isPersonOfficer) {
                        if (actionType === 'add') STATE.duties[currentMonth][dayKey] = person;
                        else if (STATE.duties[currentMonth][dayKey] === person) delete STATE.duties[currentMonth][dayKey];
                    }
                    if (isPersonTechnician) update(STATE.techDuties, dayKey, assignment, actionType === 'add');
                }
            },

            // --- Управление персоналом ---
            addOfficer(name) {
                if (STATE.userRole !== 'admin') {
                    VIEW.showNotification('Только администратор может добавлять сотрудников.', 'error');
                    return;
                }
                if (!name || !CONFIG.NAME_REGEX.test(name)) {
                    VIEW.showNotification("Введите имя в формате 'Фамилия И.О.'", 'error');
                    return;
                }
                if ([...STATE.officers, ...STATE.technicians].includes(name)) {
                    VIEW.showNotification('Такой сотрудник уже существует.', 'info');
                    return;
                }
                STATE.officers.push(name);
                STATE.technicians.push(name);
                VIEW.showNotification(`Сотрудник ${name} добавлен.`, 'success');
                document.querySelector(CONFIG.DOM_SELECTORS.newOfficerName).value = '';
                this.saveData();
                VIEW.renderManagementList();
            },

            async deleteOfficer(name) {
                if (STATE.userRole !== 'admin') {
                    VIEW.showNotification('Только администратор может удалять сотрудников.', 'error');
                    return;
                }
                const confirmed = await VIEW.showConfirmModal(`Вы уверены, что хотите удалить ${name}? Все его назначения будут стерты.`);
                if (!confirmed) return;

                STATE.officers = STATE.officers.filter(o => o !== name);
                STATE.technicians = STATE.technicians.filter(t => t !== name);

                for (let i = 0; i < 12; i++) {
                    ['duties', 'techDuties', 'generalSchedule'].forEach(key => {
                        Object.keys(STATE[key][i] || {}).forEach(day => {
                            if (key === 'duties') {
                                if (STATE[key][i][day] === name) delete STATE[key][i][day];
                            } else {
                                STATE[key][i][day] = STATE[key][i][day].filter(a => a.person !== name);
                                if(STATE[key][i][day].length === 0) delete STATE[key][i][day];
                            }
                        });
                    });
                }
                this.saveData();
                VIEW.renderAll();
            },
            
            async clearMonth() {
                const confirmed = await VIEW.showConfirmModal(`Вы уверены, что хотите очистить все данные для текущего месяца в графике "${STATE.activeTab}"?`);
                if (!confirmed) return;

                const keyMap = { duty: 'duties', technician: 'techDuties', general: 'generalSchedule' };
                STATE[keyMap[STATE.activeTab]][STATE.currentMonth] = {};
                this.saveData();
                VIEW.renderAll();
            },
            
            async cancelChanges() {
                const confirmed = await VIEW.showConfirmModal('Отменить все несохраненные изменения?');
                if(confirmed) {
                    this.loadData();
                    VIEW.renderAll();
                }
            }
        };

        /**
         * VIEW: Отвечает за все манипуляции с DOM. Только читает из STATE.
         */
        const VIEW = {
            init() {
                this.renderAppShell();
                this.renderAll();
            },
            
            renderAppShell() {
                const container = document.querySelector(CONFIG.DOM_SELECTORS.container);
                container.innerHTML = `
                    <header class="header">
                        <div class="user-info" id="userInfo"></div>
                        <h1>Календарь дежурств</h1>
                        <select class="month-selector" id="monthSelector"></select>
                        <button class="btn btn--edit-mode" id="toggleEditModeBtn" data-action="toggleEditMode">Редактировать</button>
                    </header>
                    <main class="main-content">
                        <nav class="tab-navigation" id="tabNavigation">
                            <button class="tab-button active btn" data-tab="duty">График дежурств</button>
                            <button class="tab-button btn" data-tab="technician">График техников</button>
                            <button class="tab-button btn" data-tab="general">Общий график</button>
                        </nav>
                        <div class="section-container">
                            <div id="dutyTab" class="tab-content active"><div class="calendar-grid" id="dutyCalendarGrid" data-calendar-type="duty"></div></div>
                            <div id="technicianTab" class="tab-content"><div class="calendar-grid" id="technicianCalendarGrid" data-calendar-type="technician"></div></div>
                            <div id="generalTab" class="tab-content"><div class="calendar-grid" id="generalCalendarGrid" data-calendar-type="general"></div></div>
                            <div class="action-buttons-wrapper hidden" id="actionButtons">
                                <button class="btn btn--save" data-action="save">Сохранить изменения</button>
                                <button class="btn btn--cancel" data-action="cancel">Отменить изменения</button>
                                <button class="btn btn--clear" data-action="clear">Очистить месяц</button>
                            </div>
                        </div>
                        <button class="btn btn--toggle" data-action="toggleSection" data-target="statisticsSection">Статистика</button>
                        <div class="section-container hidden-section" id="statisticsSection">
                            <h3>Статистика дежурств</h3>
                            <div class="stats-list" id="statsList"></div>
                        </div>
                        <button class="btn btn--toggle" data-action="toggleSection" data-target="managementSection" style="margin-top: 10px;">Управление</button>
                        <div class="section-container hidden-section" id="managementSection">
                            <h3>Управление персоналом</h3>
                            <div class="officer-management-controls">
                                <input type="text" id="newOfficerName" placeholder="Имя нового сотрудника (Фамилия И.О.)">
                                <button class="btn btn--save" data-action="addOfficer">Добавить</button>
                            </div>
                            <div class="current-officers-list" id="currentOfficersList"></div>
                        </div>
                    </main>`;
                this.renderUserInfo();
            },

            renderUserInfo() {
                const userInfoContainer = document.getElementById('userInfo');
                if (userInfoContainer) {
                    const { first_name, username } = STATE.telegramUser;
                    const roleText = { admin: 'Администратор', user: 'Пользователь' }[STATE.userRole] || 'Гость';
                    userInfoContainer.innerHTML = `Вы вошли как <span>${first_name}</span> (@${username}) | Роль: <span>${roleText}</span>`;
                }
            },

            renderUnauthorized() {
                const container = document.querySelector(CONFIG.DOM_SELECTORS.container);
                container.innerHTML = `<div class="unauthorized"><h1>Доступ запрещен</h1><p>У вас нет прав для просмотра этого приложения.</p></div>`;
                window.Telegram.WebApp.close();
            },

            renderAll() {
                this.renderMonthSelector();
                this.renderTabsAndButtons();
                this.renderAllCalendars();
                this.renderStatistics();
                this.renderManagementList();
            },

            renderAllCalendars() {
                this.renderCalendar('duty');
                this.renderCalendar('technician');
                this.renderCalendar('general');
            },
            
            renderMonthSelector() {
                const selector = document.querySelector(CONFIG.DOM_SELECTORS.monthSelector);
                selector.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const monthName = new Date(STATE.year, i).toLocaleString('ru-RU', { month: 'long' });
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${STATE.year}`;
                    option.selected = (i === STATE.currentMonth);
                    selector.appendChild(option);
                }
            },

            renderTabsAndButtons() {
                document.querySelectorAll('#tabNavigation .tab-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === STATE.activeTab);
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === `${STATE.activeTab}Tab`);
                });
                document.querySelector(CONFIG.DOM_SELECTORS.actionButtons).classList.toggle('hidden', !STATE.isEditMode);
                document.querySelectorAll('#actionButtons button').forEach(btn => {
                    if (btn.dataset.action !== 'clear') btn.disabled = !STATE.hasUnsavedChanges;
                });
                const editBtn = document.getElementById('toggleEditModeBtn');
                editBtn.textContent = STATE.isEditMode ? 'Завершить' : 'Редактировать';
                editBtn.classList.toggle('btn--cancel', STATE.isEditMode);
                editBtn.classList.toggle('btn--edit-mode', !STATE.isEditMode);
            },

            renderCalendar(calendarType) {
                const grid = document.querySelector(CONFIG.DOM_SELECTORS[`${calendarType}CalendarGrid`]);
                if (!grid) return;

                const dataMap = { duty: STATE.duties, technician: STATE.techDuties, general: STATE.generalSchedule };
                const monthData = dataMap[calendarType][STATE.currentMonth] || {};
                
                const fragment = document.createDocumentFragment();
                ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.textContent = day;
                    fragment.appendChild(header);
                });

                const firstDayOfMonth = new Date(STATE.year, STATE.currentMonth, 1);
                const daysInMonth = new Date(STATE.year, STATE.currentMonth + 1, 0).getDate();
                const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

                for (let i = 0; i < firstDayOfWeek; i++) {
                    fragment.appendChild(document.createElement('div')).className = 'day-cell empty';
                }

                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.dataset.day = day;
                    
                    const date = new Date(STATE.year, STATE.currentMonth, day);
                    const dayOfWeek = (date.getDay() + 6) % 7;
                    if (dayOfWeek >= 5) cell.classList.add('weekend');
                    if (date.toDateString() === today.toDateString()) cell.classList.add('current-day');
                    
                    cell.innerHTML = `<div class="day-number">${day}</div><div class="day-entries-container"></div>`;
                    
                    const dayAssignments = monthData[day] || [];
                    const assignmentsArray = Array.isArray(dayAssignments) ? dayAssignments : (typeof dayAssignments === 'string' ? [{ person: dayAssignments, shift: '' }] : []);
                    
                    const entriesContainer = cell.querySelector('.day-entries-container');
                    assignmentsArray.forEach(a => entriesContainer.appendChild(this.createDayEntry(a.person, a.shift)));
                    
                    fragment.appendChild(cell);
                }
                
                grid.innerHTML = '';
                grid.appendChild(fragment);
            },
            
            createDayEntry(person, shift) {
                const entry = document.createElement('div');
                entry.className = 'day-entry';
                entry.title = shift ? `${person} (${shift})` : person;
                
                const personColor = this.getColorFor(person);
                entry.style.backgroundColor = personColor;
                entry.style.color = this.isLightColor(personColor) ? '#333' : '#fff';
                
                entry.innerHTML = `<span>${person.split(' ')[0]}</span>` + (shift ? `<span class="shift-type">(${shift})</span>` : '');
                return entry;
            },

            renderStatistics() {
                const stats = {};
                STATE.officers.forEach(o => { stats[o] = 0; });
                
                Object.values(STATE.duties[STATE.currentMonth] || {}).forEach(officer => {
                    if (officer) stats[officer] = (stats[officer] || 0) + 1;
                });
                
                const sortedOfficers = Object.keys(stats).sort((a, b) => stats[b] - stats[a]);
                
                const statsList = document.querySelector(CONFIG.DOM_SELECTORS.statsList);
                statsList.innerHTML = '';
                sortedOfficers.forEach(officer => {
                    const item = document.createElement('div');
                    item.className = 'stats-item';
                    const color = this.getColorFor(officer);
                    item.innerHTML = `<div class="stats-name" style="background-color:${color}; color:${this.isLightColor(color) ? '#333' : '#fff'}">${officer}</div>
                                      <div class="stats-count">${stats[officer]}</div>`;
                    statsList.appendChild(item);
                });
            },
            
            renderManagementList() {
                const list = document.querySelector(CONFIG.DOM_SELECTORS.currentOfficersList);
                list.innerHTML = '';
                [...new Set([...STATE.officers, ...STATE.technicians])].sort().forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'current-officer-item';
                    item.innerHTML = `<span>${name}</span>
                                      <button class="delete-officer-btn" data-action="deleteOfficer" data-name="${name}" title="Удалить ${name}">&times;</button>`;
                    list.appendChild(item);
                });
            },

            // --- Модальные окна ---
            showDutyModal() {
                const modal = document.querySelector(CONFIG.DOM_SELECTORS.editModal.body);
                document.querySelector(CONFIG.DOM_SELECTORS.editModal.title).textContent = 'Выберите дежурного';
                
                const currentAssignment = STATE.duties[STATE.currentMonth][STATE.currentSelectedDay];
                const optionsHTML = [...STATE.officers, CONFIG.NO_DUTY_LABEL].map(name => {
                    const isSelected = (name === currentAssignment || (!currentAssignment && name === CONFIG.NO_DUTY_LABEL));
                    return `<button class="officer-option btn ${isSelected ? 'selected' : ''}" data-action="selectDuty" data-name="${name}">${name}</button>`;
                }).join('');
                
                modal.innerHTML = `<div class="officer-list">${optionsHTML}</div>`;
                this.openModal('edit');
            },

            showAssignmentModal(calendarType) {
                const modal = document.querySelector(CONFIG.DOM_SELECTORS.editModal.body);
                document.querySelector(CONFIG.DOM_SELECTORS.editModal.title).textContent = `Назначить смену на ${STATE.currentSelectedDay}-е число`;
                modal.dataset.calendarType = calendarType;

                const people = calendarType === 'technician' ? STATE.technicians : [...new Set([...STATE.officers, ...STATE.technicians])].sort();
                
                const peopleOptionsHTML = people.map(p => `<option value="${p}">${p}</option>`).join('');
                const shiftOptionsHTML = CONFIG.SHIFT_TYPES.map((s, i) => `<option value="${s}" ${i === 0 ? 'selected' : ''}>${s}</option>`).join('');

                modal.innerHTML = `
                    <div class="assignment-controls">
                        <select id="personSelect">${peopleOptionsHTML}</select>
                        <select id="shiftSelect">${shiftOptionsHTML}</select>
                        <button class="btn btn--save" data-action="addAssignment">Добавить назначение</button>
                    </div>
                    <div class="assignments-list-container">
                        <h5>Текущие назначения:</h5>
                        <div id="assignmentsList"></div>
                    </div>`;
                
                this.renderAssignmentModalList(calendarType);
                this.openModal('edit');
            },

            showEnlargedDayView(day) {
                const { year, currentMonth } = STATE;
                const fullDate = new Date(year, currentMonth, day).toLocaleString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
                document.querySelector(CONFIG.DOM_SELECTORS.viewModal.title).textContent = fullDate;
                const body = document.querySelector(CONFIG.DOM_SELECTORS.viewModal.body);
                body.innerHTML = '';

                const allAssignments = [...(STATE.generalSchedule[currentMonth][day] || [])];
                
                const uniqueAssignments = Array.from(new Map(allAssignments.map(a => [`${a.person}-${a.shift}`, a])).values());
                
                if (uniqueAssignments.length === 0) {
                    body.innerHTML = '<p>На этот день нет назначений.</p>';
                } else {
                    uniqueAssignments.sort((a,b) => a.person.localeCompare(b.person));
                    uniqueAssignments.forEach(a => {
                        const p = document.createElement('p');
                        const color = this.getColorFor(a.person);
                        p.style.backgroundColor = color;
                        p.style.color = this.isLightColor(color) ? '#333' : '#fff';
                        p.textContent = `${a.person} (${a.shift})`;
                        body.appendChild(p);
                    });
                }
                this.openModal('view');
            },
            
            renderAssignmentModalList(calendarType) {
                const list = document.getElementById('assignmentsList');
                if (!list) return;
                
                const keyMap = { technician: 'techDuties', general: 'generalSchedule' };
                const assignments = STATE[keyMap[calendarType]][STATE.currentMonth][STATE.currentSelectedDay] || [];
                
                if (assignments.length === 0) {
                    list.innerHTML = 'Нет назначений.';
                    return;
                }
                list.innerHTML = assignments.map((a, i) => `
                    <div class="assignment-item">
                        <span>${a.person} (${a.shift})</span>
                        <button class="delete-assignment-btn" data-action="deleteAssignment" data-index="${i}">&times;</button>
                    </div>`).join('');
            },

            openModal(type) {
                document.querySelector(CONFIG.DOM_SELECTORS[type + 'Modal'].overlay).classList.add('show');
                document.querySelector(`.day-cell[data-day='${STATE.currentSelectedDay}']`)?.classList.add('selected-for-modal');
            },

            closeModal() {
                document.querySelector(CONFIG.DOM_SELECTORS.editModal.overlay).classList.remove('show');
                document.querySelector(CONFIG.DOM_SELECTORS.viewModal.overlay).classList.remove('show');
                const prevSelected = document.querySelector('.day-cell.selected-for-modal');
                if (prevSelected) prevSelected.classList.remove('selected-for-modal');
                STATE.currentSelectedDay = null;
            },
            
            showConfirmModal(message) {
                return new Promise(resolve => {
                    STATE.confirmModalResolve = resolve;
                    document.querySelector(CONFIG.DOM_SELECTORS.confirmModal.message).textContent = message;
                    document.querySelector(CONFIG.DOM_SELECTORS.confirmModal.overlay).classList.add('show');
                });
            },

            closeConfirmModal(result) {
                document.querySelector(CONFIG.DOM_SELECTORS.confirmModal.overlay).classList.remove('show');
                if (STATE.confirmModalResolve) {
                    STATE.confirmModalResolve(result);
                    STATE.confirmModalResolve = null;
                }
            },

            // --- Утилиты ---
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 3000);
            },
            
            getColorFor(str) {
                if(!str) return '#ccc';
                if (STATE.colors[str]) return STATE.colors[str];
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                let color = '#';
                for (let i = 0; i < 3; i++) {
                    const value = (hash >> (i * 8)) & 0xFF;
                    color += ('00' + value.toString(16)).substr(-2);
                }
                return STATE.colors[str] = color;
            },

            isLightColor(hex) {
                const r = parseInt(hex.substring(1, 3), 16);
                const g = parseInt(hex.substring(3, 5), 16);
                const b = parseInt(hex.substring(5, 7), 16);
                return (r * 299 + g * 587 + b * 114) / 1000 > 180;
            },
        };

        /**
         * CONTROLLER: Связывает действия пользователя с логикой приложения.
         */
        const CONTROLLER = {
            init() {
                document.body.addEventListener('click', this.globalClickListener.bind(this));
                document.addEventListener('change', e => {
                    if (e.target.matches(CONFIG.DOM_SELECTORS.monthSelector)) {
                        SERVICE.changeMonth(e.target.value);
                    }
                });
            },

            globalClickListener(e) {
                const target = e.target;
                
                const dayCell = target.closest('.day-cell:not(.empty)');
                if (dayCell) {
                    const grid = dayCell.closest('.calendar-grid');
                    SERVICE.handleDayClick(parseInt(dayCell.dataset.day, 10), grid.dataset.calendarType);
                    return;
                }

                const tabButton = target.closest('.tab-button[data-tab]');
                if (tabButton) {
                    SERVICE.switchTab(tabButton.dataset.tab);
                    return;
                }

                const actionTarget = target.closest('[data-action]');
                if (actionTarget) {
                    const { action, name, index } = actionTarget.dataset;
                    
                    switch (action) {
                        case 'toggleEditMode': SERVICE.toggleEditMode(); break;
                        case 'save': SERVICE.saveData(); break;
                        case 'clear': SERVICE.clearMonth(); break;
                        case 'cancel': SERVICE.cancelChanges(); break;
                        case 'toggleSection': document.getElementById(actionTarget.dataset.target)?.classList.toggle('hidden-section'); break;
                        case 'addOfficer': SERVICE.addOfficer(document.querySelector(CONFIG.DOM_SELECTORS.newOfficerName).value); break;
                        case 'deleteOfficer': SERVICE.deleteOfficer(name); break;
                        case 'closeModal': VIEW.closeModal(); break;
                        case 'closeConfirmModal': VIEW.closeConfirmModal(false); break;
                        case 'selectDuty': SERVICE.assignDuty(name); break;
                        case 'addAssignment': {
                            const modalBody = target.closest('.modal-body');
                            const person = modalBody.querySelector('#personSelect').value;
                            const shift = modalBody.querySelector('#shiftSelect').value;
                            SERVICE.addAssignment(person, shift, modalBody.dataset.calendarType);
                            break;
                        }
                        case 'deleteAssignment': {
                             const modalBody = target.closest('.modal-body');
                             SERVICE.deleteAssignment(parseInt(index, 10), modalBody.dataset.calendarType);
                             break;
                        }
                    }
                }
                
                if(target.matches(CONFIG.DOM_SELECTORS.confirmModal.confirmBtn)) VIEW.closeConfirmModal(true);
                if(target.matches(CONFIG.DOM_SELECTORS.confirmModal.cancelBtn)) VIEW.closeConfirmModal(false);
            }
        };

        window.addEventListener('load', () => SERVICE.init());

    })();
    </script>
</body>
</html>
